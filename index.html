<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Scoring Quiz</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --success: #00b894;
            --error: #d63031;
            --bg: #dfe6e9;
            --card-bg: #ffffff;
            --text: #2d3436;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        #game-ui {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: bold;
            color: #636e72;
            font-size: 1.1rem;
        }

        /* Animated Score Update */
        .score-change {
            font-size: 0.9rem;
            margin-left: 5px;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
        }
        .score-up { color: var(--success); }
        .score-none { color: var(--error); }

        .timer-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin-bottom: 25px;
            overflow: hidden;
            display: none; 
        }
        .timer-fill {
            height: 100%;
            background: var(--primary);
            width: 100%;
            transition: width 1s linear;
        }

        h2 { margin-bottom: 25px; font-size: 1.5rem; line-height: 1.4; }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button.option-btn {
            background: #f1f2f6;
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            font-weight: 600;
        }

        button.option-btn:hover:not(:disabled) {
            background: #e1e2e6;
            transform: translateY(-2px);
        }

        button.correct {
            background-color: var(--success) !important;
            color: white !important;
            border-color: var(--success) !important;
        }

        button.wrong {
            background-color: var(--error) !important;
            color: white !important;
            border-color: var(--error) !important;
            opacity: 0.7;
        }

        button:disabled {
            cursor: default;
            transform: none !important;
        }

        #game-over { text-align: center; display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-ui">
        <div class="hud">
            <span>Question <span id="current-q">1</span>/<span id="total-q">10</span></span>
            <span>
                Score: <span id="current-score">0</span>
                <span id="score-anim" class="score-change">+0</span>
            </span>
        </div>

        <div id="timer-bar-container" class="timer-bar">
            <div id="timer-fill" class="timer-fill"></div>
        </div>

        <h2 id="question-text">Loading...</h2>

        <div id="options-container" class="options-grid"></div>
        
        <p id="feedback-text" style="height: 20px; color: #888; font-size: 0.9rem; margin-top:15px;"></p>
    </div>

    <div id="game-over" class="hidden">
        <h1>Quiz Complete!</h1>
        <p>Correct Answers: <span id="final-correct">0</span></p>
        <h2 style="color: var(--primary); font-size: 3rem; margin: 20px 0;">
            <span id="final-score">0</span>
        </h2>
        <p>Sending to Hub...</p>
    </div>

    <script>
        // --- 1. DATA & CONFIG ---
        const QUESTION_BANK = [
            { "q": "What does CPU stand for?", "options": ["Central Process Unit", "Central Processing Unit", "Computer Personal Unit", "Central Program Unit"], "ans": 1 },
            { "q": "Which language is primarily used for web page structure?", "options": ["CSS", "JavaScript", "HTML", "Python"], "ans": 2 },
            { "q": "Which data structure uses FIFO?", "options": ["Stack", "Queue", "Tree", "Graph"], "ans": 1 },
            { "q": "Binary number system base?", "options": ["2", "8", "10", "16"], "ans": 0 },
            { "q": "Which is not an operating system?", "options": ["Linux", "Windows", "Oracle", "macOS"], "ans": 2 },
            { "q": "RAM is?", "options": ["Permanent memory", "Secondary memory", "Volatile memory", "External memory"], "ans": 2 },
            { "q": "Which symbol is used for comments in C?", "options": ["//", "#", "<!-- -->", "**"], "ans": 0 },
            { "q": "Which protocol is used for web browsing?", "options": ["FTP", "SMTP", "HTTP", "SNMP"], "ans": 2 },
            { "q": "Which is a relational database?", "options": ["MongoDB", "MySQL", "Redis", "Cassandra"], "ans": 1 },
            { "q": "Time complexity of binary search?", "options": ["O(n)", "O(log n)", "O(nÂ²)", "O(1)"], "ans": 1 },

            { "q": "Which device is an input device?", "options": ["Monitor", "Printer", "Keyboard", "Speaker"], "ans": 2 },
            { "q": "Hexadecimal base?", "options": ["2", "8", "10", "16"], "ans": 3 },
            { "q": "Which language is used for styling web pages?", "options": ["HTML", "CSS", "PHP", "SQL"], "ans": 1 },
            { "q": "Which is not a programming paradigm?", "options": ["Procedural", "Object-oriented", "Functional", "Incremental"], "ans": 3 },
            { "q": "Which company developed Java?", "options": ["Microsoft", "Sun Microsystems", "IBM", "Oracle"], "ans": 1 },
            { "q": "Which is the brain of the computer?", "options": ["RAM", "Hard Disk", "CPU", "Motherboard"], "ans": 2 },
            { "q": "Default port of HTTP?", "options": ["21", "25", "80", "443"], "ans": 2 },
            { "q": "Which sorting algorithm is fastest on average?", "options": ["Bubble Sort", "Selection Sort", "Quick Sort", "Insertion Sort"], "ans": 2 },
            { "q": "Which is not a valid Python data type?", "options": ["list", "tuple", "array", "set"], "ans": 2 },
            { "q": "SQL is used for?", "options": ["Styling", "Logic building", "Database querying", "Networking"], "ans": 2 },

            { "q": "Which memory is fastest?", "options": ["RAM", "Cache", "Hard Disk", "ROM"], "ans": 1 },
            { "q": "Which is an example of an OS?", "options": ["Chrome", "Linux", "MySQL", "Python"], "ans": 1 },
            { "q": "Which operator is used for assignment in C?", "options": ["==", "=", "!=", "<="], "ans": 1 },
            { "q": "Which layer does TCP belong to?", "options": ["Application", "Transport", "Network", "Data Link"], "ans": 1 },
            { "q": "Which is a NoSQL database?", "options": ["PostgreSQL", "Oracle", "MongoDB", "MySQL"], "ans": 2 },
            { "q": "Which loop executes at least once?", "options": ["for", "while", "do-while", "foreach"], "ans": 2 },
            { "q": "What does URL stand for?", "options": ["Uniform Resource Locator", "Universal Reference Link", "Unified Resource Line", "Uniform Reference Locator"], "ans": 0 },
            { "q": "Which is not a file system?", "options": ["NTFS", "FAT32", "EXT4", "TCP"], "ans": 3 },
            { "q": "Which key uniquely identifies a record?", "options": ["Foreign key", "Candidate key", "Primary key", "Composite key"], "ans": 2 },
            { "q": "Which language is interpreted?", "options": ["C", "C++", "Java", "Python"], "ans": 3 },

            { "q": "What does IDE stand for?", "options": ["Integrated Development Environment", "Internal Design Engine", "Integrated Data Editor", "Internal Development Editor"], "ans": 0 },
            { "q": "Which algorithm technique uses divide and conquer?", "options": ["Bubble Sort", "Merge Sort", "Linear Search", "Insertion Sort"], "ans": 1 },
            { "q": "Which is not a network topology?", "options": ["Star", "Bus", "Ring", "Treehouse"], "ans": 3 },
            { "q": "Which symbol is used for logical AND?", "options": ["&", "&&", "|", "||"], "ans": 1 },
            { "q": "Which OS is open-source?", "options": ["Windows", "macOS", "Linux", "DOS"], "ans": 2 },
            { "q": "Which component stores BIOS?", "options": ["RAM", "ROM", "Cache", "Hard Disk"], "ans": 1 },
            { "q": "Which protocol is used to send email?", "options": ["HTTP", "FTP", "SMTP", "POP3"], "ans": 2 },
            { "q": "Which normal form removes transitive dependency?", "options": ["1NF", "2NF", "3NF", "BCNF"], "ans": 2 },
            { "q": "Which is a front-end framework?", "options": ["Django", "Laravel", "React", "Flask"], "ans": 2 },
            { "q": "Which command is used to list files in Linux?", "options": ["ls", "dir", "list", "show"], "ans": 0 },

            { "q": "Which device converts digital to analog?", "options": ["ADC", "DAC", "Modem", "Router"], "ans": 1 },
            { "q": "What is the size of int in C (typically)?", "options": ["2 bytes", "4 bytes", "8 bytes", "Depends on compiler"], "ans": 3 },
            { "q": "Which is not a DBMS?", "options": ["SQLite", "MongoDB", "Excel", "PostgreSQL"], "ans": 2 },
            { "q": "Which data structure uses LIFO?", "options": ["Queue", "Stack", "Array", "Linked List"], "ans": 1 },
            { "q": "Which language runs in the browser?", "options": ["C", "Java", "Python", "JavaScript"], "ans": 3 },
            { "q": "Which is not an IP address?", "options": ["192.168.1.1", "127.0.0.1", "255.255.255.0", "999.10.1.1"], "ans": 3 },
            { "q": "Which type of attack floods a network?", "options": ["Phishing", "DDoS", "Spoofing", "Sniffing"], "ans": 1 },
            { "q": "Which symbol denotes pointer in C?", "options": ["&", "*", "#", "@"], "ans": 1 },
            { "q": "Which cloud model provides infrastructure?", "options": ["SaaS", "PaaS", "IaaS", "FaaS"], "ans": 2 },
            { "q": "Which OS scheduling is preemptive?", "options": ["FCFS", "SJF", "Round Robin", "Priority (non-preemptive)"], "ans": 2 },

            { "q": "Which is an example of system software?", "options": ["MS Word", "Photoshop", "Linux", "Chrome"], "ans": 2 },
            { "q": "Which layer handles encryption?", "options": ["Application", "Presentation", "Session", "Transport"], "ans": 1 },
            { "q": "Which data type stores true/false?", "options": ["int", "char", "bool", "float"], "ans": 2 },
            { "q": "Which command creates a directory in Linux?", "options": ["touch", "mkdir", "rmdir", "cd"], "ans": 1 },
            { "q": "Which sorting has worst O(nÂ²)?", "options": ["Merge Sort", "Heap Sort", "Bubble Sort", "Quick Sort"], "ans": 2 },
            { "q": "Which is a version control system?", "options": ["Docker", "Git", "Jenkins", "Kubernetes"], "ans": 1 },
            { "q": "Which protocol resolves IP to MAC?", "options": ["DNS", "ARP", "RARP", "ICMP"], "ans": 1 },
            { "q": "Which is not a Java keyword?", "options": ["static", "void", "include", "class"], "ans": 2 },
            { "q": "Which is a markup language?", "options": ["HTML", "Python", "C", "Java"], "ans": 0 },
            { "q": "Which storage is secondary storage?", "options": ["Cache", "RAM", "Register", "Hard Disk"], "ans": 3 }
        ];

        const urlParams = new URLSearchParams(window.location.search);
        let currentSeed = parseInt(urlParams.get('seed')) || 12345;
        const requestedCount = parseInt(urlParams.get('count')) || 5;
        const TOTAL_QUESTIONS = Math.min(requestedCount, QUESTION_BANK.length);
        const SECONDS_PER_QUESTION = parseInt(urlParams.get('timer')) || 0; 

        // --- 2. STATE ---
        let questions = [];
        let currentQIndex = 0;
        let currentScore = 0; // Live Score
        let correctAnswers = 0;
        let questionTimerInterval;
        let questionTimeLeft;
        let questionStartTime; // To track time per question

        // --- 3. HELPERS ---
        function seededRandom() {
            var x = Math.sin(currentSeed++) * 10000;
            return x - Math.floor(x);
        }

        function getSeededQuestions() {
            let shuffled = [...QUESTION_BANK];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled.slice(0, TOTAL_QUESTIONS);
        }

        // --- 4. GAME LOOP ---
        function initGame() {
            questions = getSeededQuestions();
            document.getElementById('total-q').innerText = TOTAL_QUESTIONS;
            if (SECONDS_PER_QUESTION > 0) {
                document.getElementById('timer-bar-container').style.display = 'block';
            }
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQIndex >= questions.length) {
                endGame();
                return;
            }

            const qData = questions[currentQIndex];
            
            // UI Reset
            document.getElementById('current-q').innerText = currentQIndex + 1;
            document.getElementById('question-text').innerText = qData.q;
            document.getElementById('feedback-text').innerText = "";
            document.getElementById('score-anim').style.opacity = '0'; // Hide previous anim

            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';

            qData.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(index);
                optionsDiv.appendChild(btn);
            });

            // Start Timer for this specific question
            questionStartTime = Date.now();
            if (SECONDS_PER_QUESTION > 0) {
                startQuestionTimer();
            }
        }

        function startQuestionTimer() {
            clearInterval(questionTimerInterval);
            questionTimeLeft = SECONDS_PER_QUESTION;
            updateTimerBar();

            questionTimerInterval = setInterval(() => {
                questionTimeLeft--;
                updateTimerBar();
                if (questionTimeLeft <= 0) {
                    clearInterval(questionTimerInterval);
                    handleAnswer(-1); // Timeout
                }
            }, 1000);
        }

        function updateTimerBar() {
            const percentage = (questionTimeLeft / SECONDS_PER_QUESTION) * 100;
            document.getElementById('timer-fill').style.width = percentage + "%";
        }

        // --- 5. SCORING & ANSWER HANDLING ---
        function handleAnswer(selectedIndex) {
            clearInterval(questionTimerInterval);
            
            const qData = questions[currentQIndex];
            const buttons = document.querySelectorAll('.option-btn');
            const isCorrect = selectedIndex === qData.ans;
            const timeTakenSec = (Date.now() - questionStartTime) / 1000;

            // Disable buttons
            buttons.forEach(btn => btn.disabled = true);

            let pointsEarned = 0;

            if (isCorrect) {
                // Correct UI
                if(selectedIndex !== -1) buttons[selectedIndex].classList.add('correct');
                correctAnswers++;
                
                // === SCORING LOGIC ===
                // Base points for getting it right
                pointsEarned = 1000; 

                if (SECONDS_PER_QUESTION > 0) {
                    // MODE A: TIMED
                    // Bonus: 10 points for every second LEFT
                    pointsEarned += Math.ceil(questionTimeLeft * 10);
                } else {
                    // MODE B: UNTIMED
                    // Penalty: Deduct 10 points for every second TAKEN
                    // (Minimum score of 500 to ensure getting it right is always worth it)
                    const penalty = Math.floor(timeTakenSec * 10);
                    pointsEarned = Math.max(1000 - penalty, 500);
                }

                showScoreAnim(pointsEarned);
                currentScore += pointsEarned;
                document.getElementById('current-score').innerText = currentScore;
                document.getElementById('feedback-text').innerText = "Correct!";
            } else {
                // Wrong UI
                if(selectedIndex !== -1) buttons[selectedIndex].classList.add('wrong');
                buttons[qData.ans].classList.add('correct'); // Show right answer
                
                document.getElementById('feedback-text').innerText = selectedIndex === -1 ? "Time's Up!" : "Wrong!";
                showScoreAnim(0);
            }

            // Next Question Delay
            setTimeout(() => {
                currentQIndex++;
                loadQuestion();
            }, 1500);
        }

        function showScoreAnim(amount) {
            const animEl = document.getElementById('score-anim');
            if (amount > 0) {
                animEl.innerText = `+${amount}`;
                animEl.className = "score-change score-up";
            } else {
                animEl.innerText = "+0";
                animEl.className = "score-change score-none";
            }
            animEl.style.opacity = '1';
            animEl.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                animEl.style.transform = 'translateY(0)';
            }, 500);
        }

        function endGame() {
            // UI Switch
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('game-over').classList.remove('hidden');
            document.getElementById('game-over').style.display = 'block';

            document.getElementById('final-correct').innerText = `${correctAnswers} / ${TOTAL_QUESTIONS}`;
            document.getElementById('final-score').innerText = currentScore;

            submitScoreToHub(currentScore);
        }

        function submitScoreToHub(finalScore) {
            console.log("ðŸ“¤ Sending score to hub:", finalScore);
            window.parent.postMessage({ 
                type: 'GAME_OVER', 
                payload: { score: finalScore } 
            }, '*');
        }

        window.onload = initGame;

    </script>
</body>
</html>